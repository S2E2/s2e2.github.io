<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Instrumenting guest code with Lua &mdash; S2E 2.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Analyzing large programs using concolic execution" href="Concolic.html" />
    <link rel="prev" title="How to Write an S2E plugin" href="WritingPlugins.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> S2E
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../s2e-env.html">Start here: setting up S2E</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../s2e-env.html#installing-s2e-env">Installing s2e-env</a></li>
<li class="toctree-l2"><a class="reference internal" href="../s2e-env.html#using-s2e-env">Using s2e-env</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../s2e-env.html#creating-a-new-environment">Creating a new environment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../s2e-env.html#s2e-activate"><code class="docutils literal notranslate"><span class="pre">s2e_activate</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../s2e-env.html#building-s2e">Building S2E</a></li>
<li class="toctree-l3"><a class="reference internal" href="../s2e-env.html#updating-the-source-code">Updating the source code</a></li>
<li class="toctree-l3"><a class="reference internal" href="../s2e-env.html#building-an-image">Building an image</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../s2e-env.html#windows-images">Windows images</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../s2e-env.html#creating-a-new-analysis-project">Creating a new analysis project</a></li>
<li class="toctree-l3"><a class="reference internal" href="../s2e-env.html#target-program-arguments">Target program arguments</a></li>
<li class="toctree-l3"><a class="reference internal" href="../s2e-env.html#using-seed-files">Using seed files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../s2e-env.html#running-your-analysis">Running your analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../s2e-env.html#parsing-an-execution-trace">Parsing an execution trace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../s2e-env.html#importing-and-exporting-projects">Importing and exporting projects</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../s2e-env.html#next-steps">Next steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../BuildingS2E.html">Building the S2E platform manually</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../BuildingS2E.html#building-using-docker">Building using Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BuildingS2E.html#building-s2e-manually">Building S2E manually</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../BuildingS2E.html#required-packages">Required packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BuildingS2E.html#checking-out-s2e">Checking out S2E</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BuildingS2E.html#building">Building</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BuildingS2E.html#updating">Updating</a></li>
<li class="toctree-l3"><a class="reference internal" href="../BuildingS2E.html#building-the-documentation">Building the documentation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/BasicLinuxSymbex/s2e.so.html">Symbolic Execution of Linux Binaries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/BasicLinuxSymbex/s2e.so.html#getting-started">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/BasicLinuxSymbex/s2e.so.html#using-s2e-so">Using <code class="docutils literal notranslate"><span class="pre">s2e.so</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/BasicLinuxSymbex/s2e.so.html#what-about-other-symbolic-input">What about other symbolic input?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/BasicLinuxSymbex/s2e.so.html#configuring-s2e-for-use-with-s2e-so">Configuring S2E for use with <code class="docutils literal notranslate"><span class="pre">s2e.so</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/BasicLinuxSymbex/s2e.so.html#modifying-and-building-s2e-so">Modifying and building <code class="docutils literal notranslate"><span class="pre">s2e.so</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/BasicLinuxSymbex/SourceCode.html">Instrumenting Program Source Code for S2E</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/BasicLinuxSymbex/SourceCode.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/BasicLinuxSymbex/SourceCode.html#compiling-and-running">Compiling and running</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/BasicLinuxSymbex/SourceCode.html#preparing-the-program-for-symbolic-execution">Preparing the program for symbolic execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/BasicLinuxSymbex/SourceCode.html#running-the-program-in-s2e">Running the program in S2E</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/BasicLinuxSymbex/SourceCode.html#terminating-execution-paths">Terminating execution paths</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Use Cases</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/PoV/pov.html">Automated Generation of Proofs of Vulnerability with S2E</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/PoV/pov.html#understanding-the-execution-of-a-vulnerable-program">Understanding the Execution of a Vulnerable Program</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/PoV/pov.html#using-symbolic-execution-to-generate-povs">Using Symbolic Execution to Generate PoVs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/PoV/pov.html#identifying-advanced-vulnerability-patterns-with-s2e">Identifying Advanced Vulnerability Patterns with S2E</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/PoV/pov.html#function-pointer-overwrite">Function Pointer Overwrite</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/PoV/pov.html#arbitrary-writes">Arbitrary Writes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/PoV/pov.html#arbitrary-reads">Arbitrary Reads</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/PoV/pov.html#function-calls-with-symbolic-parameters">Function Calls with Symbolic Parameters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/PoV/pov.html#generating-replayable-povs">Generating Replayable PoVs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/PoV/pov.html#conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/PoV/index.html">Using S2E to generate PoVs for Linux, Windows, and CGC binaries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/PoV/index.html#quickstart-on-windows-and-linux">Quickstart on Windows and Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/PoV/index.html#understanding-recipes">Understanding recipes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/PoV/index.html#povs-for-darpa-decree-cgc-binaries">PoVs for DARPA Decree/CGC binaries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/PoV/index.html#understanding-cgc-style-povs">Understanding CGC-style PoVs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/PoV/index.html#plugin-architecture-overview">Plugin architecture overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/PoV/index.html#plugins-involved-in-pov-generation">Plugins involved in PoV generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/PoV/index.html#the-bootstrap-script">The bootstrap script</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://adrianherrera.github.io/post/kaitai-s2e">Combining Kaitai Struct and S2E for analyzing parsers [external]</a></li>
<li class="toctree-l1"><a class="reference external" href="https://adrianherrera.github.io/post/malware-s2e">Analyzing trigger-based malware with S2E [external]</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/SystemTap/index.html">Using SystemTap with S2E</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/SystemTap/index.html#building-and-running-systemtap-in-s2e">Building and running SystemTap in S2E</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/SystemTap/index.html#creating-a-simple-systemtap-script-for-symbolic-execution">Creating a simple SystemTap script for symbolic execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/SystemTap/index.html#running-the-script-in-s2e">Running the script in S2E</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/WindowsDLL/index.html">Analysis of Windows DLLs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/WindowsDLL/index.html#preparing-the-test-environment">Preparing the test environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/WindowsDLL/index.html#generate-basic-block-coverage">Generate basic block coverage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/WindowsDrivers/FaultInjection.html">Testing Error Recovery Code in Windows Drivers with Multi-Path Fault Injection</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/WindowsDrivers/FaultInjection.html#setting-up-s2e">Setting up S2E</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/WindowsDrivers/FaultInjection.html#setting-up-the-windows-environment">Setting up the Windows Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/WindowsDrivers/FaultInjection.html#building-the-sample-driver">Building the Sample Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/WindowsDrivers/FaultInjection.html#creating-an-s2e-driver-project">Creating an S2E Driver Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/WindowsDrivers/FaultInjection.html#customizing-the-driver-project">Customizing the Driver Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/WindowsDrivers/FaultInjection.html#running-the-driver">Running the Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/WindowsDrivers/FaultInjection.html#getting-code-coverage-reports">Getting Code Coverage Reports</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/WindowsDrivers/FaultInjection.html#testing-error-recovery-code">Testing Error Recovery Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/WindowsDrivers/FaultInjection.html#generating-crash-dumps">Generating Crash Dumps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/WindowsDrivers/FaultInjection.html#understanding-s2e-logs-and-test-cases">Understanding S2E Logs and Test Cases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/WindowsDrivers/FaultInjection.html#customizing-fault-injection">Customizing Fault Injection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/WindowsDrivers/FaultInjection.html#debugging-tips">Debugging Tips</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/MSOffice/index.html">Analyzing Microsoft Office Documents</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/MSOffice/index.html#building-a-microsoft-office-image">Building a Microsoft Office image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/MSOffice/index.html#creating-a-test-document">2. Creating a test document</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/MSOffice/index.html#creating-an-analysis-project">3. Creating an analysis project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/MSOffice/index.html#running-the-project">4. Running the project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/MSOffice/index.html#exercises">5. Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/MSOffice/index.html#conclusion">6. Conclusion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/CFI/index.html">Control Flow Integrity Checking with S2E</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/CFI/index.html#setting-up-microsoft-office">Setting up Microsoft Office</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/CFI/index.html#running-the-cfi-checker">Running the CFI checker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/CFI/index.html#analyzing-a-malicious-document">Analyzing a malicious document</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/CFI/index.html#locating-cfi-violations">Locating CFI violations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/CFI/index.html#setting-up-windbg-for-analysis">Setting up WinDbg for analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/CFI/index.html#tracing-the-exploit">Tracing the exploit</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/CFI/index.html#design-and-implementation">Design and implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/CFI/index.html#limitations">Limitations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/CFI/index.html#conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/Revgen/Revgen.html">Translating binaries to LLVM with Revgen</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Revgen/Revgen.html#using-revgen">Using Revgen</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/Revgen/Revgen.html#prerequisites">1. Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/Revgen/Revgen.html#build-the-cgc-binaries">2. Build the CGC binaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/Revgen/Revgen.html#translating-a-binary">3. Translating a binary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/Revgen/Revgen.html#running-a-translated-cgc-binary">4. Running a translated CGC binary</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Revgen/Revgen.html#design-and-implementation">Design and implementation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/Revgen/Revgen.html#translating-basic-blocks-to-llvm">Translating basic blocks to LLVM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/Revgen/Revgen.html#stitching-basic-blocks-into-functions">Stitching basic blocks into functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/Revgen/Revgen.html#assumptions">Assumptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Tutorials/Revgen/Revgen.html#running-translated-binaries">Running translated binaries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Revgen/Revgen.html#evaluation">Evaluation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../EquivalenceTesting.html">Equivalence Testing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../EquivalenceTesting.html#program-to-test">Program to Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="../EquivalenceTesting.html#configuring-s2e">Configuring S2E</a></li>
<li class="toctree-l2"><a class="reference internal" href="../EquivalenceTesting.html#running-the-program-in-s2e">Running the Program in S2E</a></li>
<li class="toctree-l2"><a class="reference internal" href="../EquivalenceTesting.html#interpreting-the-results">Interpreting the Results</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Howtos</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Coverage/index.html">Measuring code coverage with S2E</a><ul>
<li class="toctree-l2"><a class="reference internal" href="Coverage/index.html#line-coverage-for-linux-binaries">Line coverage for Linux binaries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="Coverage/index.html#building-coreutils">Building Coreutils</a></li>
<li class="toctree-l3"><a class="reference internal" href="Coverage/index.html#running-coreutils-concretely-in-s2e">Running Coreutils concretely in S2E</a></li>
<li class="toctree-l3"><a class="reference internal" href="Coverage/index.html#generating-line-coverage">Generating line coverage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Coverage/index.html#line-coverage-for-shared-libraries">Line coverage for shared libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="Coverage/index.html#basic-block-coverage">Basic block coverage</a></li>
<li class="toctree-l2"><a class="reference internal" href="Coverage/index.html#code-coverage-during-symbolic-execution">Code coverage during symbolic execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="Coverage/index.html#how-does-s2e-record-and-compute-coverage">How does S2E record and compute coverage?</a></li>
<li class="toctree-l2"><a class="reference internal" href="Coverage/index.html#line-coverage-for-the-linux-kernel">Line coverage for the Linux kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="Coverage/index.html#line-coverage-for-windows-binaries">Line coverage for Windows binaries</a></li>
<li class="toctree-l2"><a class="reference internal" href="Coverage/index.html#debugging-code-coverage">Debugging code coverage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Plugins/BaseInstructions.html">Communicating between the guest and S2E plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MovingFiles.html">Copying files between the host and the guest</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../MovingFiles.html#s2eget"><code class="docutils literal notranslate"><span class="pre">s2eget</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../MovingFiles.html#s2eput"><code class="docutils literal notranslate"><span class="pre">s2eput</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../MovingFiles.html#setting-up-the-hostfiles-plugin">Setting up the HostFiles Plugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Parallel.html">Running S2E on multiple cores</a><ul>
<li class="toctree-l2"><a class="reference internal" href="Parallel.html#handling-execution-traces">Handling execution traces</a></li>
<li class="toctree-l2"><a class="reference internal" href="Parallel.html#limitations">Limitations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ExecutionTracers.html">Using execution tracers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="ExecutionTracers.html#recording-basic-traces">1. Recording basic traces</a></li>
<li class="toctree-l2"><a class="reference internal" href="ExecutionTracers.html#analyzing-traces">2. Analyzing traces</a></li>
<li class="toctree-l2"><a class="reference internal" href="ExecutionTracers.html#recording-memory-traces">3. Recording memory traces</a></li>
<li class="toctree-l2"><a class="reference internal" href="ExecutionTracers.html#trace-format-reference">4. Trace format reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ImageInstallation.html">Customizing stock VM images</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ImageInstallation.html#image-creation-overview">Image creation overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ImageInstallation.html#building-linux-images">Building Linux images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ImageInstallation.html#building-windows-images">Building Windows images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ImageInstallation.html#when-should-i-install-my-software">When should I install my software?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ImageInstallation.html#the-s2e-vm-image-format">The S2E VM image format</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ImageInstallation.html#general-guidelines-for-vm-images">General guidelines for VM images</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="WritingPlugins.html">Writing S2E plugins</a><ul>
<li class="toctree-l2"><a class="reference internal" href="WritingPlugins.html#starting-with-an-empty-plugin">Starting with an empty plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="WritingPlugins.html#reading-configuration-parameters">Reading configuration parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="WritingPlugins.html#instrumenting-instructions">Instrumenting instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="WritingPlugins.html#counting-instructions">Counting instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="WritingPlugins.html#exporting-events">Exporting events</a></li>
<li class="toctree-l2"><a class="reference internal" href="WritingPlugins.html#guest-plugin-communication">Guest-plugin communication</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Instrumenting guest code with Lua</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#instrumenting-function-calls-and-returns">Instrumenting function calls and returns</a></li>
<li class="toctree-l2"><a class="reference internal" href="#instrumenting-instructions">Instrumenting instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#api-reference">API Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#luas2eexecutionstate">LuaS2EExecutionState</a></li>
<li class="toctree-l3"><a class="reference internal" href="#luas2eexecutionstatememory">LuaS2EExecutionStateMemory</a></li>
<li class="toctree-l3"><a class="reference internal" href="#luas2eexecutionstateregisters">LuaS2EExecutionStateRegisters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#luafunctioninstrumentationstate">LuaFunctionInstrumentationState</a></li>
<li class="toctree-l3"><a class="reference internal" href="#luainstructioninstrumentationstate">LuaInstructionInstrumentationState</a></li>
<li class="toctree-l3"><a class="reference internal" href="#luaexpression">LuaExpression</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-g-s2e-object">The <code class="docutils literal notranslate"><span class="pre">g_s2e</span></code> object</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Scaling Symbolic Execution</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Concolic.html">Analyzing large programs using concolic execution</a><ul>
<li class="toctree-l2"><a class="reference internal" href="Concolic.html#executing-programs-in-concolic-mode">Executing programs in concolic mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="Concolic.html#faq">FAQ</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../StateMerging.html">Exponential Analysis Speedup with State Merging</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../StateMerging.html#using-state-merging-in-s2e">Using State Merging in S2E</a></li>
<li class="toctree-l2"><a class="reference internal" href="../StateMerging.html#state-merging-api">State Merging API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../StateMerging.html#limitations">Limitations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Tools/ForkProfiler.html">Debugging path explosion with the fork profiler</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Tools/ForkProfiler.html#using-the-fork-profile-to-debug-path-explosion">Using the fork profile to debug path explosion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html">Frequently Asked Questions (FAQ)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../FAQ.html#how-do-i-know-what-s2e-is-doing">How do I know what S2E is doing?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FAQ.html#execution-seems-stuck-slow-what-to-do">Execution seems stuck/slow. What to do?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FAQ.html#how-do-i-deal-with-path-explosion">How do I deal with path explosion?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FAQ.html#how-to-keep-memory-usage-low">How to keep memory usage low?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FAQ.html#how-much-time-is-the-constraint-solver-taking-to-solve-constraints">How much time is the constraint solver taking to solve constraints?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FAQ.html#what-do-the-various-fields-in-run-stats-mean">What do the various fields in <code class="docutils literal notranslate"><span class="pre">run.stats</span></code> mean?</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html">Symbolic Execution Extensions for KVM</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#kernel-based-virtual-machine-kvm">Kernel-based Virtual Machine (KVM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#emulating-the-kvm-interface">Emulating the KVM interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#using-system-call-hooks-for-emulation">Using system call hooks for emulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#differences-between-actual-kvm-and-kvm-emulation">Differences between actual KVM and KVM emulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#adding-symbolic-execution-capabilities-to-kvm">Adding symbolic execution capabilities to KVM</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#multi-path-execution">Multi-path execution</a></li>
<li class="toctree-l3"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#handling-symbolic-data">Handling symbolic data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#reference">Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#dynamic-binary-translation">Dynamic binary translation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#registering-memory-regions">Registering memory regions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#accessing-guest-memory">Accessing guest memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#interrupting-execution">Interrupting execution</a></li>
<li class="toctree-l3"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#virtual-disk-i-o">Virtual disk I/O</a></li>
<li class="toctree-l3"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#saving-restoring-device-snapshots">Saving/restoring device snapshots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#setting-the-clock-scale-pointer">Setting the clock scale pointer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../DesignAndImplementation/KvmInterface.html#kvm-run-exit-codes">KVM_RUN exit codes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Contribute.html">Contributing to S2E</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Profiling/ProfilingS2E.html">Profiling S2E</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Profiling/ProfilingS2E.html#profiling-memory-usage">Profiling memory usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Profiling/ProfilingS2E.html#profiling-cpu-performance">Profiling CPU performance</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../DebuggingS2E.html">Debugging S2E</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../DebuggingS2E.html#the-obvious-checks">The obvious checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DebuggingS2E.html#record-replay">Record-replay</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DebuggingS2E.html#valgrind">Valgrind</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DebuggingS2E.html#debugging-with-gdb">Debugging with gdb</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DebuggingS2E.html#s2e-kernel-debugging">S2E kernel debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DebuggingS2E.html#s2e-debug-functions">S2E debug functions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Testsuite.html">S2E Testsuite</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Testsuite.html#building-the-testsuite">Building the testsuite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Testsuite.html#running-the-testsuite">Running the testsuite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Testsuite.html#adding-your-own-tests">Adding your own tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Testsuite.html#test-configuration-reference">Test configuration reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../WindowsEnvSetup.html">Setting up a Windows development environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../WindowsEnvSetup.html#provisioning-a-windows-development-vm">1. Provisioning a Windows development VM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../WindowsEnvSetup.html#building-visual-studio-projects-remotely">2. Building Visual Studio projects remotely</a></li>
<li class="toctree-l2"><a class="reference internal" href="../WindowsEnvSetup.html#use-case-building-and-running-a-windows-device-driver">3. Use case: building and running a Windows device driver</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Plugin Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Plugins/Linux/LinuxMonitor.html">LinuxMonitor</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/Linux/LinuxMonitor.html#options">Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/Linux/LinuxMonitor.html#required-plugins">Required Plugins</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Plugins/Windows/WindowsMonitor.html">WindowsMonitor</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/Windows/WindowsMonitor.html#options">Options</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Plugins/RawMonitor.html">RawMonitor</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/RawMonitor.html#custom-instruction">Custom Instruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/RawMonitor.html#options">Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/RawMonitor.html#configuration-sample">Configuration Sample</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Plugins/ModuleExecutionDetector.html">ModuleExecutionDetector</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/ModuleExecutionDetector.html#configuration-sample">Configuration Sample</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Plugins/Tracers/ExecutionTracer.html">ExecutionTracer</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/Tracers/ExecutionTracer.html#executiontracer">ExecutionTracer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/Tracers/ExecutionTracer.html#moduletracer">ModuleTracer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/Tracers/ExecutionTracer.html#testcasegenerator">TestCaseGenerator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/Tracers/ExecutionTracer.html#memorytracer">MemoryTracer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/Tracers/ExecutionTracer.html#translationblocktracer">TranslationBlockTracer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/Tracers/ExecutionTracer.html#instructiontracer">InstructionTracer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Plugins/FunctionMonitor.html">FunctionMonitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Plugins/Linux/FunctionModels.html">FunctionModels</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/Linux/FunctionModels.html#testing">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/Linux/FunctionModels.html#options">Options</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Plugins/EdgeKiller.html">EdgeKiller</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/EdgeKiller.html#options">Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/EdgeKiller.html#required-plugins">Required Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Plugins/EdgeKiller.html#configuration-sample">Configuration Sample</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">S2E</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Instrumenting guest code with Lua</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/Howtos/LuaInstrumentation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="instrumenting-guest-code-with-lua">
<h1>Instrumenting guest code with Lua<a class="headerlink" href="#instrumenting-guest-code-with-lua" title="Permalink to this headline"></a></h1>
<p>S2E comes with several plugins that expose its monitoring and instrumentation capabilities to scripts written in the
<a class="reference external" href="http://lua.org">Lua</a> programming language. This lets users create lightweight scripts without having to write and
build C++ plugins.</p>
<p>There are currently two instrumentation plugins:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LuaFunctionInstrumentation</span></code>: for function call instrumentation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LuaInstructionInstrumentation</span></code>: for instrumentation of individual instructions</p></li>
</ul>
<section id="instrumenting-function-calls-and-returns">
<h2>Instrumenting function calls and returns<a class="headerlink" href="#instrumenting-function-calls-and-returns" title="Permalink to this headline"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">LuaFunctionInstrumentation</span></code> plugin allows instrumenting function calls and returns. It works by monitoring
machine <code class="docutils literal notranslate"><span class="pre">call</span></code> and <code class="docutils literal notranslate"><span class="pre">ret</span></code> instructions. When execution reaches a call instruction, the plugin saves the stack pointer
that references the return address, so that when a return instruction is called, the plugin can match the stack pointer
with the corresponding call instruction. This way, users only need to specify the address of the function and need not
worry about instrumenting every return instruction of that function.</p>
<p>Suppose that you want to instrument a function in <code class="docutils literal notranslate"><span class="pre">mydll.dll</span></code>, which is loaded in a process called <code class="docutils literal notranslate"><span class="pre">my.exe</span></code>.
The address of the function (as set by the linker) is <code class="docutils literal notranslate"><span class="pre">0x4001050</span></code>. Your <code class="docutils literal notranslate"><span class="pre">s2e-config.lua</span></code> would contain the
following definitions:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">-- s2e-env configures this plugin when creating a new project for the binary my.exe.</span>
<span class="c1">-- If you need to monitor functions from another process, make sure that the name</span>
<span class="c1">-- of that process is defined here. If you forget to define it, your instrumentation</span>
<span class="c1">-- will not be called.</span>
<span class="n">add_plugin</span><span class="p">(</span><span class="s2">&quot;ProcessExecutionDetector&quot;</span><span class="p">)</span>
<span class="n">pluginsConfig</span><span class="p">.</span><span class="n">ProcessExecutionDetector</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">moduleNames</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;my.exe&quot;</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="c1">-- Manually enable FunctionMonitor and LuaFunctionInstrumentation plugins.</span>
<span class="c1">-- They are not automatically included when creating a new project.</span>
<span class="n">add_plugin</span><span class="p">(</span><span class="s2">&quot;FunctionMonitor&quot;</span><span class="p">)</span>
<span class="n">add_plugin</span><span class="p">(</span><span class="s2">&quot;LuaFunctionInstrumentation&quot;</span><span class="p">)</span>

<span class="c1">-- This is the configuration for LuaFunctionInstrumentation</span>
<span class="n">pluginsConfig</span><span class="p">.</span><span class="n">LuaFunctionInstrumentation</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">-- For each function to instrument, provide an entry in the &quot;instrumentation&quot; table</span>
    <span class="n">instrumentation</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">-- Define an instrumentation called &quot;my_instrumentation&quot;.</span>
        <span class="c1">-- This may be any string you want.</span>
        <span class="n">my_instrumentation</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1">-- The name of the module to instrument.</span>
            <span class="c1">-- This module can either be the name of a process specified</span>
            <span class="c1">-- in ProcessExecutionDetector, or a dynamic library that is loaded</span>
            <span class="c1">-- in the address space of that process.</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="s2">&quot;mylibrary.dll&quot;</span><span class="p">,</span>

            <span class="c1">-- The name of the Lua function to call when the guest function is called.</span>
            <span class="c1">-- The Lua function is defined later in this script.</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;instrumentation_func&quot;</span><span class="p">,</span>

            <span class="c1">-- The virtual address of the guest function to instrument.</span>
            <span class="c1">-- You can find this address using a disassembler (e.g., IDA or objdump).</span>
            <span class="n">pc</span> <span class="o">=</span> <span class="mh">0x4001050</span><span class="p">,</span>

            <span class="c1">-- Number of parameters that the guest function takes.</span>
            <span class="c1">-- This parameter may be zero unless you want to access parameters</span>
            <span class="c1">-- from the annotation or skip the execution of</span>
            <span class="c1">-- an stdcall function (parameters popped by the callee).</span>
            <span class="n">param_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>

            <span class="c1">-- Set to &quot;true&quot; to fork a new state when this instrumentation is triggered.</span>
            <span class="c1">-- This can be useful, e.g., to have one state run the original function</span>
            <span class="c1">-- and another state skip that function and replace it with a faster</span>
            <span class="c1">-- model to speed up symbolic execution.</span>
            <span class="n">fork</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>

            <span class="c1">-- Calling convention of the function. Either &quot;cdecl&quot; or &quot;stdcall&quot;.</span>
            <span class="n">convention</span> <span class="o">=</span> <span class="s2">&quot;cdecl&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">-- The instrumentation code goes here</span>
<span class="kr">function</span> <span class="nf">instrumentation_func</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">instrumentation_state</span><span class="p">,</span> <span class="n">is_call</span><span class="p">,</span> <span class="n">param1</span><span class="p">,</span> <span class="n">param2</span><span class="p">)</span>
    <span class="kr">if</span> <span class="n">is_call</span> <span class="kr">then</span>
        <span class="c1">-- Handle the function call</span>
        <span class="n">g_s2e</span><span class="p">:</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;function called!&quot;</span><span class="p">)</span>
    <span class="kr">else</span>
        <span class="c1">-- Handle the function return</span>
        <span class="n">g_s2e</span><span class="p">:</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;function returned!&quot;</span><span class="p">)</span>
    <span class="kr">end</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>An instrumentation function has the following arguments:</p>
<ol class="arabic simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">LuaS2EExecutionState</span></code> object.
Gives access to the execution state. It is the equivalent of <code class="docutils literal notranslate"><span class="pre">S2EExecutionState</span></code> in C++ plugins.
You can use this object to read/write registers/memory or kill the state.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">LuaInstrumentationState</span></code> object.
Controls the behavior of the instrumentation. For example, you can instruct S2E to skip the function call
altogether. You can read more about it later in this document.</p></li>
<li><p>A boolean value indicating whether the function is being called or is returning.</p></li>
</ol>
<p>In addition, an instrumentation function may have one or more additional parameters, each containing the address of
a guest function argument on the stack. Note that this will only work for calling conventions that use the stack
to pass their arguments.</p>
</section>
<section id="instrumenting-instructions">
<h2>Instrumenting instructions<a class="headerlink" href="#instrumenting-instructions" title="Permalink to this headline"></a></h2>
<p>Suppose you are at a “Capture the Flag” (CTF) competition and are given a binary that contains an encrypted flag. To get
that flag, you need to give a correct password on the command line. The binary is obfuscated, and you cannot extract this
flag easily, so you decide to try symbolic execution. Unfortunately, this causes quite a bit of path explosion
out-of-the-box, so you still cannot get the flag. So, you look at the binary and identify two interesting program
counters: the first one is reached when the password is correct, while the second one is executed as soon as there is an
invalid character in the password. You can use this knowledge to speed up symbolic execution. When the correct program
counter is reached, you can kill all paths and exit S2E immediately. When the bad program counter is reached, however,
you can terminate the execution path in order to avoid wasting time. For this, you could configure the
<code class="docutils literal notranslate"><span class="pre">LuaInstructionInstrumentation</span></code> plugin as follows:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">add_plugin</span><span class="p">(</span><span class="s2">&quot;ProcessExecutionDetector&quot;</span><span class="p">)</span>
<span class="n">pluginsConfig</span><span class="p">.</span><span class="n">ProcessExecutionDetector</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">moduleNames</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ctf-challenge-binary&quot;</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">pluginsConfig</span><span class="p">.</span><span class="n">LuaInstructionInstrumentation</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">-- For each instruction to instrument, provide an entry in the &quot;instrumentation&quot; table</span>
    <span class="n">instrumentation</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">-- Defines an instrumentation called &quot;success&quot;</span>
        <span class="n">success</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1">-- The name of the module that we are interested in</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="s2">&quot;ctf-challenge-binary&quot;</span><span class="p">,</span>

            <span class="c1">-- The name of the Lua function to call when the guest executes the instruction</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;on_success&quot;</span><span class="p">,</span>

            <span class="c1">-- The virtual address of the instruction in the given module</span>
            <span class="n">pc</span> <span class="o">=</span> <span class="mh">0x800123</span><span class="p">,</span>
        <span class="p">},</span>

        <span class="c1">-- Defines an instrumentation called &quot;failure&quot;</span>
        <span class="n">failure</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="s2">&quot;ctf-challenge&quot;</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;on_failure&quot;</span><span class="p">,</span>
            <span class="n">pc</span> <span class="o">=</span> <span class="mh">0x800565</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">-- An instruction instrumentation takes</span>
<span class="c1">-- a LuaS2EExecutionState object and a LuaInstrumentationState object.</span>
<span class="kr">function</span> <span class="nf">on_success</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">instrumentation_state</span><span class="p">)</span>
    <span class="c1">-- Do something in the success state</span>
    <span class="n">g_s2e</span><span class="p">:</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found secret!&quot;</span><span class="p">)</span>

    <span class="c1">-- No need to continue running S2E - terminate</span>
    <span class="n">g_s2e</span><span class="p">:</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">on_failure</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">instrumentation_state</span><span class="p">)</span>
    <span class="c1">-- There is no reason to continue execution any further because any other paths</span>
    <span class="c1">-- that will fork from here will not lead to success.</span>
    <span class="n">state</span><span class="p">:</span><span class="n">kill</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Dead-end path&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>This is a common pattern used by other symbolic execution engines (e.g. Angr, Manticore, etc.) for solving Capture
the Flag (CTF) challenges. This pattern allows users to specify:</p>
<ol class="arabic simple">
<li><p>Program path(s) that indicate the successful capture of the flag; and</p></li>
<li><p>Program path(s) to <strong>avoid</strong> (e.g., because they lead to some kind of failure state).</p></li>
</ol>
<p>The above Lua code defines the <code class="docutils literal notranslate"><span class="pre">success</span></code> and <code class="docutils literal notranslate"><span class="pre">failure</span></code> instrumentation. The <code class="docutils literal notranslate"><span class="pre">success</span></code> instrumentation calls the
<code class="docutils literal notranslate"><span class="pre">on_success</span></code> function when the instruction at <code class="docutils literal notranslate"><span class="pre">0x800123</span></code> is executed in the module <code class="docutils literal notranslate"><span class="pre">ctf-challenge</span></code> (and
likewise for the <code class="docutils literal notranslate"><span class="pre">failure</span></code> instrumentation).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For a concrete demonstration of <code class="docutils literal notranslate"><span class="pre">LuaInstructionInstrumentation</span></code> and <code class="docutils literal notranslate"><span class="pre">LuaFunctionInstrumentation</span></code>, refer to
the S2E <a class="reference external" href="../Testsuite.html">testsuite</a>, which contains an
<a class="reference external" href="https://github.com/S2E/s2e/tree/master/testsuite/basic7-instmon">example</a> of how to instrument a sample CTF
challenge.</p>
</div>
</section>
<section id="api-reference">
<h2>API Reference<a class="headerlink" href="#api-reference" title="Permalink to this headline"></a></h2>
<p>As mentioned previously, all instrumentation functions take the following two arguments:</p>
<ol class="arabic simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">LuaS2EExecutionState</span></code> object, containing the current execution state; and</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">LuaInstrumentationState</span></code> object, containing the current state of the instrumentation.</p></li>
</ol>
<section id="luas2eexecutionstate">
<h3>LuaS2EExecutionState<a class="headerlink" href="#luas2eexecutionstate" title="Permalink to this headline"></a></h3>
<p>An execution state object is a wrapper around the <code class="docutils literal notranslate"><span class="pre">S2EExecutionState</span></code> class. It provides the following methods:</p>
<dl class="simple">
<dt><strong>mem()</strong></dt><dd><p>Returns the current memory state in a <code class="docutils literal notranslate"><span class="pre">LuaS2EExecutionStateMemory</span></code> object.</p>
</dd>
<dt><strong>regs()</strong></dt><dd><p>Returns the current register state in a <code class="docutils literal notranslate"><span class="pre">LuaS2EExecutionStateRegisters</span></code> object.</p>
</dd>
<dt><strong>createSymbolicValue(name, size)</strong></dt><dd><p>Creates a new symbolic value with the given name and size (in bytes). The symbolic value is returned as a
<code class="docutils literal notranslate"><span class="pre">LuaExpression</span></code> object.</p>
</dd>
<dt><strong>kill(status, message)</strong></dt><dd><p>Kills the current state with the given status code (an integer) and message.</p>
</dd>
<dt><strong>getPluginProperty(plugin_name, property_name)</strong></dt><dd><p>Retrieves a property from the given plugin and returns it as a string.</p>
</dd>
<dt><strong>setPluginProperty(plugin_name, property_name, value)</strong></dt><dd><p>Sets a plugin property with the given string value.</p>
</dd>
<dt><strong>debug(message)</strong></dt><dd><p>Writes the given message string to the debug log.</p>
</dd>
</dl>
</section>
<section id="luas2eexecutionstatememory">
<h3>LuaS2EExecutionStateMemory<a class="headerlink" href="#luas2eexecutionstatememory" title="Permalink to this headline"></a></h3>
<p>This is a wrapper around the <code class="docutils literal notranslate"><span class="pre">S2EExecutionStateMemory</span></code> class.</p>
<dl class="simple">
<dt><strong>readPointer(address)</strong></dt><dd><p>Read a (concrete) pointer at the given address.</p>
</dd>
<dt><strong>readBytes(address, size)</strong></dt><dd><p>Read a string of (concrete) bytes from the given address.</p>
</dd>
<dt><strong>write(address, expr)</strong></dt><dd><p>Write a <code class="docutils literal notranslate"><span class="pre">LuaExpression</span></code> object at the given address.</p>
</dd>
<dt><strong>write(address, value, size)</strong></dt><dd><p>Write the given <code class="docutils literal notranslate"><span class="pre">value</span></code> at the specified <code class="docutils literal notranslate"><span class="pre">address</span></code>.</p>
</dd>
<dt><strong>makeSymbolic(address, size, name)</strong></dt><dd><p>Make a region of memory symbolic.</p>
</dd>
</dl>
</section>
<section id="luas2eexecutionstateregisters">
<h3>LuaS2EExecutionStateRegisters<a class="headerlink" href="#luas2eexecutionstateregisters" title="Permalink to this headline"></a></h3>
<p>This is a wrapper around the <code class="docutils literal notranslate"><span class="pre">S2EExecutionStateRegisters</span></code> class.</p>
<dl class="simple">
<dt><strong>getPc()</strong></dt><dd><p>Return the current program counter.</p>
</dd>
<dt><strong>getSp()</strong></dt><dd><p>Return the current stack pointer.</p>
</dd>
<dt><strong>read(pointer, size)</strong></dt><dd><p>Read the register offset by <code class="docutils literal notranslate"><span class="pre">pointer</span></code>.</p>
</dd>
<dt><strong>write(pointer, expr)</strong></dt><dd><p>Write the <code class="docutils literal notranslate"><span class="pre">LuaExpression</span></code> object at the register offset by <code class="docutils literal notranslate"><span class="pre">pointer</span></code>.</p>
</dd>
<dt><strong>write(pointer, value, size)</strong></dt><dd><p>Write the given value at the register offset by <code class="docutils literal notranslate"><span class="pre">pointer</span></code>.</p>
</dd>
</dl>
</section>
<section id="luafunctioninstrumentationstate">
<h3>LuaFunctionInstrumentationState<a class="headerlink" href="#luafunctioninstrumentationstate" title="Permalink to this headline"></a></h3>
<p>An object of this type provides the following methods:</p>
<dl class="simple">
<dt><strong>skipFunction(skip)</strong></dt><dd><p>Set <code class="docutils literal notranslate"><span class="pre">skip</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> in order to skip the function call.</p>
</dd>
<dt><strong>isChild()</strong></dt><dd><p>Returns <code class="docutils literal notranslate"><span class="pre">true</span></code> if the instrumentation state is a forked child. This is used when <code class="docutils literal notranslate"><span class="pre">fork</span> <span class="pre">=</span> <span class="pre">true</span></code> is set
in the configuration.</p>
</dd>
<dt><strong>setExitCpuLoop(exit)</strong></dt><dd><p>Set <code class="docutils literal notranslate"><span class="pre">skip</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> in order to exit the CPU loop when the instrumentation returns.
This may be useful if you modify the program counter in your instrumentation code.</p>
</dd>
</dl>
</section>
<section id="luainstructioninstrumentationstate">
<h3>LuaInstructionInstrumentationState<a class="headerlink" href="#luainstructioninstrumentationstate" title="Permalink to this headline"></a></h3>
<p>An object of this type provides the following methods:</p>
<dl class="simple">
<dt><strong>skipInstruction(skip)</strong></dt><dd><p>Set <code class="docutils literal notranslate"><span class="pre">skip</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> in order to skip the instruction after the Lua function returns.</p>
</dd>
<dt><strong>setExitCpuLoop(exit)</strong></dt><dd><p>Set <code class="docutils literal notranslate"><span class="pre">skip</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> in order to exit the CPU loop when the instrumentation returns.
This may be useful if you modify the program counter in your instrumentation code.</p>
</dd>
</dl>
</section>
<section id="luaexpression">
<h3>LuaExpression<a class="headerlink" href="#luaexpression" title="Permalink to this headline"></a></h3>
<p>This wrapper around a <code class="docutils literal notranslate"><span class="pre">klee::Expr</span></code> object.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Symbolic expression support in Lua scripts is currently experimental and limited.</p>
</div>
</section>
<section id="the-g-s2e-object">
<h3>The <code class="docutils literal notranslate"><span class="pre">g_s2e</span></code> object<a class="headerlink" href="#the-g-s2e-object" title="Permalink to this headline"></a></h3>
<p>Finally, the global <code class="docutils literal notranslate"><span class="pre">g_s2e</span></code> object is available throughout <cite>s2e-config.lua</cite>. It provides the following methods:</p>
<dl class="simple">
<dt><strong>debug(message)</strong></dt><dd><p>Write the given message string to the debug log.</p>
</dd>
<dt><strong>info(message)</strong></dt><dd><p>Write the given message string to the info log.</p>
</dd>
<dt><strong>warning(message)</strong></dt><dd><p>Write the given message string to the warning log.</p>
</dd>
<dt><strong>exit(return_code)</strong></dt><dd><p>Exit S2E with the given return code.</p>
</dd>
<dt><strong>getPlugin(plugin_name)</strong></dt><dd><p>Return a reference to the specified plugin. This allows Lua scripts to interact with compatible C++ S2E plugins.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only a fraction of the APIs available to C++ plugins are exposed to Lua. If you find that an API is missing,
add it by modifying the corresponding <code class="docutils literal notranslate"><span class="pre">LuaXXX.cpp</span></code> file.</p>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="WritingPlugins.html" class="btn btn-neutral float-left" title="How to Write an S2E plugin" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Concolic.html" class="btn btn-neutral float-right" title="Analyzing large programs using concolic execution" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2020, Cyberhaven.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-75283635-2', 'auto');
      ga('send', 'pageview');
</script>


</body>
</html>